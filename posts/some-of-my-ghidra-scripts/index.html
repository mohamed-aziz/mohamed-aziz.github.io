<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Mohamed Aziz Knani (محمد عزيز الكناني) website/posts/some-of-my-ghidra-scripts/</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="all,follow">
    <meta name="googlebot" content="index,follow,snippet,archive">
    <link rel="stylesheet" href="https://aziz.tn/hugo-theme-console/css/terminal-0.7.1.min.css">
    <link rel="stylesheet" href="https://aziz.tn/hugo-theme-console/css/animate-3.7.2.min.css">
    <link rel="stylesheet" href="https://aziz.tn/hugo-theme-console/css/console.css">
    
      <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
      <![endif]-->
       <meta property="og:title" content="Some of my ghidra scripts" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://aziz.tn/posts/some-of-my-ghidra-scripts/" /><meta property="article:published_time" content="2019-12-10T00:00:00+01:00" />



<meta name="twitter:title" content="Some of my ghidra scripts"/>
<meta name="twitter:description" content="AllCyclomaticComplexity.java This a script to calculate the cyclomatic complexity of all the functions, as the name implies the metric is correlated with function complexity, it is the sum of unique paths within the CFG. You can read more about it here.
Ghidra offers the functionality actually, this is just a wrapper to loop over all functions and sort them. What is nice about the ghidra console is when you print a function name you can click it."/>

</head>
<body class="terminal">
    <div class="container">
        <div class="terminal-nav">
          <header class="terminal-logo">
            <div class="logo terminal-prompt">
              
              
              <a href="https://aziz.tn/" class="no-style ">Mohamed Aziz Knani (محمد عزيز الكناني) website</a>:~# 
              <a href='https://aziz.tn/posts'>posts</a>/<a href='https://aziz.tn/posts/some-of-my-ghidra-scripts'>some-of-my-ghidra-scripts</a>/</div></header>
          <nav class="terminal-menu">
            <ul vocab="https://schema.org/" typeof="BreadcrumbList">
                
                <li><a href="https://aziz.tn/about/" typeof="ListItem">about/</a></li>
                
                <li><a href="https://aziz.tn/posts/" typeof="ListItem">posts/</a></li>
                
            </ul>
          </nav>
        </div>
    </div>

    <div class="container animated fadeInDown fast" >
        
<h1>Some of my ghidra scripts</h1>

Dec. 10, 2019


<br/><br/>
<h2 id="allcyclomaticcomplexity-dot-java">AllCyclomaticComplexity.java</h2>
<p>This a script to calculate the cyclomatic complexity of all the functions, as the name implies the metric is correlated with function complexity, it is the sum of unique paths within the CFG. You can read more about it <a href="https://en.wikipedia.org/wiki/Cyclomatic%5Fcomplexity">here</a>.</p>
<p>Ghidra offers the functionality actually, this is just a wrapper to loop over all functions and sort them. What is nice about the ghidra console is when you print a function name you can click it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/* ###
</span><span style="color:#75715e"> * IP: GHIDRA
</span><span style="color:#75715e"> * REVIEWED: YES
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
</span><span style="color:#75715e"> * you may not use this file except in compliance with the License.
</span><span style="color:#75715e"> * You may obtain a copy of the License at
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> *      http://www.apache.org/licenses/LICENSE-2.0
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * Unless required by applicable law or agreed to in writing, software
</span><span style="color:#75715e"> * distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
</span><span style="color:#75715e"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span><span style="color:#75715e"> * See the License for the specific language governing permissions and
</span><span style="color:#75715e"> * limitations under the License.
</span><span style="color:#75715e"> */</span>
<span style="color:#75715e">//Script to compute and print the cyclomatic complexity of the current function.
</span><span style="color:#75715e">//@category Functions
</span><span style="color:#75715e"></span>
<span style="color:#f92672">import</span> ghidra.app.script.GhidraScript<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> ghidra.program.model.listing.Function<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> ghidra.program.util.CyclomaticComplexity<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.io.*<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.util.*<span style="color:#f92672">;</span>


<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AllCyclomaticComplexity</span> <span style="color:#66d9ef">extends</span> GhidraScript <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>currentProgram <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
	  printerr<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;no current program&#34;</span><span style="color:#f92672">);</span>
	  <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span>

      Function function <span style="color:#f92672">=</span> getFirstFunction<span style="color:#f92672">();</span>

      <span style="color:#66d9ef">int</span> count <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
      FileWriter f0 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileWriter<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/tmp/output.txt&#34;</span><span style="color:#f92672">);</span>

      String newLine <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">getProperty</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;line.separator&#34;</span><span style="color:#f92672">);</span>

      List<span style="color:#f92672">&lt;</span>Tuple<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Integer<span style="color:#f92672">&gt;&gt;</span> lst <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span>Tuple<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Integer<span style="color:#f92672">&gt;&gt;();</span>
      <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

	  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>monitor<span style="color:#f92672">.</span><span style="color:#a6e22e">isCancelled</span><span style="color:#f92672">()</span> <span style="color:#f92672">||</span> function <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
	      <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
	  <span style="color:#f92672">}</span>

	  CyclomaticComplexity cyclomaticComplexity <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> CyclomaticComplexity<span style="color:#f92672">();</span>
	  <span style="color:#66d9ef">int</span> cyc <span style="color:#f92672">=</span> cyclomaticComplexity<span style="color:#f92672">.</span><span style="color:#a6e22e">calculateCyclomaticComplexity</span><span style="color:#f92672">(</span>function<span style="color:#f92672">,</span> monitor<span style="color:#f92672">);</span>
	  f0<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;complexity: &#34;</span> <span style="color:#f92672">+</span> function<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; &#34;</span><span style="color:#f92672">+</span> cyc <span style="color:#f92672">+</span> newLine<span style="color:#f92672">);</span>
	  lst<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Tuple<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Integer<span style="color:#f92672">&gt;(</span>function<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(),</span> cyc<span style="color:#f92672">));</span>
	  function <span style="color:#f92672">=</span> getFunctionAfter<span style="color:#f92672">(</span>function<span style="color:#f92672">);</span>
	  count<span style="color:#f92672">++;</span>
      <span style="color:#f92672">}</span>
      println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Sorting by cyclomatic complexity&#34;</span><span style="color:#f92672">);</span>
      Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">sort</span><span style="color:#f92672">(</span>lst<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> ComparatorFunc<span style="color:#f92672">());</span>

      <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Tuple<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Integer<span style="color:#f92672">&gt;</span> x<span style="color:#f92672">:</span> lst<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
	  println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;complexity: &#34;</span> <span style="color:#f92672">+</span> x<span style="color:#f92672">.</span><span style="color:#a6e22e">x</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; is &#34;</span> <span style="color:#f92672">+</span> x<span style="color:#f92672">.</span><span style="color:#a6e22e">y</span><span style="color:#f92672">);</span>
      <span style="color:#f92672">}</span>

      println<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;found forward = &#34;</span> <span style="color:#f92672">+</span> count<span style="color:#f92672">);</span>
      f0<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>

    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Tuple</span><span style="color:#f92672">&lt;</span>X<span style="color:#f92672">,</span> Y<span style="color:#f92672">&gt;</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> X x<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> Y y<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Tuple</span><span style="color:#f92672">(</span>X x<span style="color:#f92672">,</span> Y y<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">x</span> <span style="color:#f92672">=</span> x<span style="color:#f92672">;</span>
      <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">y</span> <span style="color:#f92672">=</span> y<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ComparatorFunc</span> <span style="color:#66d9ef">implements</span> Comparator<span style="color:#f92672">&lt;</span>Tuple<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Integer<span style="color:#f92672">&gt;&gt;</span>  <span style="color:#f92672">{</span>
    <span style="color:#75715e">// @Override
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">compare</span><span style="color:#f92672">(</span>Tuple<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Integer<span style="color:#f92672">&gt;</span> o1<span style="color:#f92672">,</span> Tuple<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Integer<span style="color:#f92672">&gt;</span> o2<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">return</span> o1<span style="color:#f92672">.</span><span style="color:#a6e22e">y</span><span style="color:#f92672">.</span><span style="color:#a6e22e">compareTo</span><span style="color:#f92672">(</span>o2<span style="color:#f92672">.</span><span style="color:#a6e22e">y</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="xormemoryscriptbackward-dot-java">XorMemoryScriptBackward.java</h2>
<p>This is the same as XorMemoryScript.java that is shipped by default in ghidra, except that it XOR backward, I actually unpacked a malware sample this way, it xored .text but backwards.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/* ###
</span><span style="color:#75715e"> * IP: GHIDRA
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
</span><span style="color:#75715e"> * you may not use this file except in compliance with the License.
</span><span style="color:#75715e"> * You may obtain a copy of the License at
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> *      http://www.apache.org/licenses/LICENSE-2.0
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * Unless required by applicable law or agreed to in writing, software
</span><span style="color:#75715e"> * distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
</span><span style="color:#75715e"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span><span style="color:#75715e"> * See the License for the specific language governing permissions and
</span><span style="color:#75715e"> * limitations under the License.
</span><span style="color:#75715e"> */</span>
<span style="color:#75715e">//XOR&#39;s the memory of the current program.
</span><span style="color:#75715e">//@category Memory
</span><span style="color:#75715e"></span>
<span style="color:#f92672">import</span> ghidra.app.script.GhidraScript<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> ghidra.program.model.address.Address<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> ghidra.program.model.address.AddressIterator<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> ghidra.program.model.address.AddressSet<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> ghidra.program.model.address.AddressSetView<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> ghidra.program.model.mem.Memory<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> ghidra.program.model.mem.MemoryBlock<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">XorMemoryScriptBackward</span> <span style="color:#66d9ef">extends</span> GhidraScript <span style="color:#f92672">{</span>

    <span style="color:#a6e22e">@Override</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>

      <span style="color:#75715e">// default to the current memory block
</span><span style="color:#75715e"></span>      Memory memory <span style="color:#f92672">=</span> currentProgram<span style="color:#f92672">.</span><span style="color:#a6e22e">getMemory</span><span style="color:#f92672">();</span>
      MemoryBlock block <span style="color:#f92672">=</span> memory<span style="color:#f92672">.</span><span style="color:#a6e22e">getBlock</span><span style="color:#f92672">(</span>currentAddress<span style="color:#f92672">);</span>
      AddressSetView set <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AddressSet<span style="color:#f92672">(</span>block<span style="color:#f92672">.</span><span style="color:#a6e22e">getStart</span><span style="color:#f92672">(),</span>block<span style="color:#f92672">.</span><span style="color:#a6e22e">getEnd</span><span style="color:#f92672">());</span>

      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>currentSelection <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>currentSelection<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
	  set <span style="color:#f92672">=</span> currentSelection<span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span>

      <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> xorValues <span style="color:#f92672">=</span> askBytes<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;XorValue&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Values to xor with selected memory:&#34;</span><span style="color:#f92672">);</span>

      <span style="color:#66d9ef">int</span> valueLength <span style="color:#f92672">=</span> xorValues<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span>
      <span style="color:#66d9ef">int</span> xorIndex <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>

      AddressIterator aIter <span style="color:#f92672">=</span> set<span style="color:#f92672">.</span><span style="color:#a6e22e">getAddresses</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>

      <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>aIter<span style="color:#f92672">.</span><span style="color:#a6e22e">hasNext</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>monitor<span style="color:#f92672">.</span><span style="color:#a6e22e">isCancelled</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
	  Address addr <span style="color:#f92672">=</span> aIter<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">();</span>
	  monitor<span style="color:#f92672">.</span><span style="color:#a6e22e">setMessage</span><span style="color:#f92672">(</span>addr<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">());</span>
	  <span style="color:#66d9ef">byte</span> xorValue <span style="color:#f92672">=</span> xorValues<span style="color:#f92672">[</span>xorIndex<span style="color:#f92672">];</span>
	  <span style="color:#66d9ef">byte</span> b <span style="color:#f92672">=</span> memory<span style="color:#f92672">.</span><span style="color:#a6e22e">getByte</span><span style="color:#f92672">(</span>addr<span style="color:#f92672">);</span>
	  b <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">byte</span><span style="color:#f92672">)</span> <span style="color:#f92672">(</span>b <span style="color:#f92672">^</span> xorValue<span style="color:#f92672">);</span>
	  memory<span style="color:#f92672">.</span><span style="color:#a6e22e">setByte</span><span style="color:#f92672">(</span>addr<span style="color:#f92672">,</span> b<span style="color:#f92672">);</span>
	  xorIndex <span style="color:#f92672">+=</span> 1<span style="color:#f92672">;</span>
	  xorIndex <span style="color:#f92672">=</span> xorIndex <span style="color:#f92672">%</span> valueLength<span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div>


        <div class="footer">
    Powered by <a href="https://gohugo.io/">Hugo</a> with
    <a href="https://github.com/mrmierzejewski/hugo-theme-console/">Console Theme</a>. 
</div>

    </div>
  </body>
</html>
