<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Mohamed Aziz Knani (ŸÖÿ≠ŸÖÿØ ÿπÿ≤Ÿäÿ≤ ÿßŸÑŸÉŸÜÿßŸÜŸä) website/posts/bsides-2020-chameleon-reverse-engineering-writeup/</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="all,follow">
    <meta name="googlebot" content="index,follow,snippet,archive">
    <link rel="stylesheet" href="https://aziz.tn/hugo-theme-console/css/terminal-0.7.1.min.css">
    <link rel="stylesheet" href="https://aziz.tn/hugo-theme-console/css/animate-3.7.2.min.css">
    <link rel="stylesheet" href="https://aziz.tn/hugo-theme-console/css/console.css">
    
      <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
      <![endif]-->
       <meta property="og:title" content="Bsides 2020, chameleon reverse engineering writeup" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://aziz.tn/posts/bsides-2020-chameleon-reverse-engineering-writeup/" /><meta property="article:published_time" content="2020-04-09T00:00:00+01:00" />



<meta name="twitter:title" content="Bsides 2020, chameleon reverse engineering writeup"/>
<meta name="twitter:description" content="This was originally published on sousse.love
Introduction BsidesSF had really really good reverse engineering challenges, but I loved two challenges. One windows reverse challenge called chameleon and another esp32 firmware reverse challenge called smart-locky which I didn&rsquo;t manage to solve in time.
The challenge Problem statement We are given two files chameleon.exe and flag.png.enc, this looks trivial enough we need to reverse the encryption algorithm to give us the original flag."/>


<link rel="stylesheet" href="https://aziz.tn/css/syntax.css" />

</head>
<body class="terminal">
    <div class="container">
        <div class="terminal-nav">
          <header class="terminal-logo">
            <div class="logo terminal-prompt">
              
              
              <a href="https://aziz.tn/" class="no-style ">Mohamed Aziz Knani (ŸÖÿ≠ŸÖÿØ ÿπÿ≤Ÿäÿ≤ ÿßŸÑŸÉŸÜÿßŸÜŸä) website</a>:~# 
              <a href='https://aziz.tn/posts'>posts</a>/<a href='https://aziz.tn/posts/bsides-2020-chameleon-reverse-engineering-writeup'>bsides-2020-chameleon-reverse-engineering-writeup</a>/</div></header>
          <nav class="terminal-menu">
            <ul vocab="https://schema.org/" typeof="BreadcrumbList">
                
                <li><a href="https://aziz.tn/about/" typeof="ListItem">about/</a></li>
                
                <li><a href="https://aziz.tn/posts/" typeof="ListItem">posts/</a></li>
                
            </ul>
          </nav>
        </div>
    </div>

    <div class="container animated fadeInDown fast" >
        
<h1>Bsides 2020, chameleon reverse engineering writeup</h1>

Apr. 9, 2020


<br/><br/>
<p>This was originally published on <a href="https://www.sousse.love/post/chameleon-bsides/">sousse.love</a></p>
<h2 id="introduction">Introduction</h2>
<p>BsidesSF had really really good reverse engineering challenges, but I loved two challenges. One windows reverse challenge called chameleon and another esp32 firmware reverse challenge called smart-locky which I didn&rsquo;t manage to solve in time.</p>
<h2 id="the-challenge">The challenge</h2>
<h3 id="problem-statement">Problem statement</h3>
<p>We are given two files <a href="static/bsides/chameleon.exe">chameleon.exe</a> and <a href="static/bsides/flag.png.enc">flag.png.enc</a>, this looks trivial enough we need to reverse the encryption algorithm to give us the original flag.png.</p>
<p>The problem statment also says that file was encrypted in the last months.</p>
<p>Reading the statment it looked like a simple challenge where you brute force the seed of a default mt19937 implementation, but the problem had only two solves, so I thought there must be some twist.</p>
<h3 id="first-glance-at-the-binary">First glance at the binary</h3>
<p>When you first execute the binary it gives you two options, to encrypt or decrypt files.</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">Usage: chameleon.exe [--encrypt|&lt;--decrypt --id=&lt;id&gt;&gt;] &lt;infile&gt; &lt;outfile&gt;

Example: chameleon.exe --encrypt plaintext.txt ciphertext.txt
Example: chameleon.exe --decrypt --id=abcd1234 ciphertext.txt plaintext.txt
</code></pre></div><p>I knew where to look, and I didn&rsquo;t focus on the decryption stuff to be honest.</p>
<h3 id="reversing-the-binary">Reversing the binary</h3>
<p>After identifying the encrypt function and changing some function names here is what the assembly looks like (you might want to zoom):</p>
<figure>
    <img src="/bsides/encrypt_func-md.png"/> 
</figure>

<p>And here is what the hexrays decompiler gives us after changing some types and variable names:</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="n">__usercall</span> <span class="nf">encrypt</span><span class="p">(</span><span class="k">const</span> <span class="n">CHAR</span> <span class="o">*</span><span class="n">output</span><span class="err">@</span><span class="o">&lt;</span><span class="n">ebx</span><span class="o">&gt;</span><span class="p">,</span> <span class="k">const</span> <span class="n">CHAR</span> <span class="o">*</span><span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">file_content</span><span class="p">;</span>
  <span class="n">BYTE</span> <span class="o">*</span><span class="n">new_file_ptr</span><span class="p">;</span>
  <span class="n">FILE</span> <span class="o">*</span><span class="n">v4</span><span class="p">;</span>
  <span class="n">DWORD</span> <span class="n">pdwDataLen</span><span class="p">;</span>
  <span class="n">HCRYPTKEY</span> <span class="n">phKey</span><span class="p">;</span>
  <span class="n">HCRYPTPROV</span> <span class="n">phProv</span><span class="p">;</span>
  <span class="n">byte</span> <span class="n">pbData</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">v9</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

  <span class="n">file_content</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdwDataLen</span><span class="p">);</span>
  <span class="n">new_file_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">realloc</span><span class="p">(</span><span class="n">file_content</span><span class="p">,</span> <span class="n">pdwDataLen</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">CryptAcquireContextA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phProv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;Microsoft Enhanced Cryptographic Provider v1.0&#34;</span><span class="p">,</span> <span class="mi">1u</span><span class="p">,</span> <span class="mh">0xF0000000</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
  <span class="n">mersenne_twister</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">v9</span><span class="p">);</span>                    <span class="c1">// generate 8 byte key
</span><span class="c1"></span>  <span class="o">*</span><span class="p">(</span><span class="n">_WORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pbData</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">pbData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pbData</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pbData</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v9</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pbData</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v9</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
  <span class="n">pbData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pbData</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">26113</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">CryptImportKey</span><span class="p">(</span><span class="n">phProv</span><span class="p">,</span> <span class="n">pbData</span><span class="p">,</span> <span class="mh">0x14u</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1u</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phKey</span><span class="p">)</span>
    <span class="o">||</span> <span class="o">!</span><span class="n">CryptEncrypt</span><span class="p">(</span><span class="n">phKey</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">new_file_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdwDataLen</span><span class="p">,</span> <span class="n">pdwDataLen</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
<span class="nl">failure</span><span class="p">:</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="n">_iob_func</span><span class="p">();</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">v4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#34;Encryption failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">sub_E51AA0</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">v9</span><span class="p">);</span>
  <span class="n">sub_E51F50</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">new_file_ptr</span><span class="p">,</span> <span class="n">pdwDataLen</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">new_file_ptr</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>All right looks simple enough, here are the algorithm steps:</p>
<ul>
<li>call to CryptAcquireContextA, this is like an encryption algorithm factory in windows</li>
<li>call to a function that I called mersenne_twister</li>
<li>sets some values in pbData</li>
<li>call to CryptImportKey</li>
<li>call to CryptEncrypt</li>
</ul>
<p>You can read this <a href="https://docs.microsoft.com/en-us/windows/win32/seccrypto/example-c-program--importing-a-plaintext-key">tutorial</a> to understand how <strong>CryptImportKey</strong> works.</p>
<p>This is an example key blob from the page above:</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="n">BYTE</span> <span class="n">DesKeyBlob</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0x08</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x66</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span> <span class="c1">// BLOB header
</span><span class="c1"></span>    <span class="mh">0x08</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>                     <span class="c1">// key length, in bytes
</span><span class="c1"></span>    <span class="mh">0xf1</span><span class="p">,</span><span class="mh">0x0e</span><span class="p">,</span><span class="mh">0x25</span><span class="p">,</span><span class="mh">0x7c</span><span class="p">,</span><span class="mh">0x6b</span><span class="p">,</span><span class="mh">0xce</span><span class="p">,</span><span class="mh">0x0d</span><span class="p">,</span><span class="mh">0x34</span>  <span class="c1">// DES key with parity
</span><span class="c1"></span>    <span class="p">};</span>
</code></pre></div><p>We can see that our example also uses DES using CBC mode of operation, we also see that the DES key is passed as the last 8 bytes (with byte of parity) of the array.</p>
<p>Ok so the bread and butter of this problem is knowing how the mersenne twister works.</p>
<h3 id="reversing-mersenne-twister">Reversing mersenne_twister</h3>
<p>This is what the code looks like:</p>
<figure>
    <img src="/bsides/mersenne_twister-md.png"/> 
</figure>

<p>We can see that there are two loops.</p>
<p>Here is the decompiled code, it looks really clean after some type changes</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">char</span> <span class="n">__usercall</span> <span class="n">mersenne_twister</span><span class="err">@</span><span class="o">&lt;</span><span class="n">al</span><span class="o">&gt;</span><span class="p">(</span><span class="kt">int</span> <span class="n">a1</span><span class="err">@</span><span class="o">&lt;</span><span class="n">edi</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// eax
</span><span class="c1"></span>  <span class="kt">signed</span> <span class="kt">int</span> <span class="n">v2</span><span class="p">;</span> <span class="c1">// ecx
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// esi
</span><span class="c1"></span>  <span class="kt">char</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// al
</span><span class="c1"></span>
  <span class="n">v1</span> <span class="o">=</span> <span class="n">time64</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">do</span>
  <span class="p">{</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="mi">29945647</span> <span class="o">*</span> <span class="n">v1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">mt</span><span class="p">[</span><span class="n">v2</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">v1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">while</span> <span class="p">(</span> <span class="n">v2</span> <span class="o">&lt;</span> <span class="mi">351</span> <span class="p">);</span>
  <span class="n">dword_E54018</span> <span class="o">=</span> <span class="n">v2</span><span class="p">;</span>
  <span class="n">v3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">do</span>
  <span class="p">{</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">getrandom</span><span class="p">()</span> <span class="o">^</span> <span class="mh">0x55</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">v3</span><span class="o">++</span> <span class="o">+</span> <span class="n">a1</span><span class="p">)</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">while</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="p">);</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>If you implemented mersenne twister, the first loop is the set seed function, this is gonna put numbers in an array I call mt.</p>
<p>The <strong>critical</strong> part to notice is the call to time64, the twister is seeded with current time.</p>
<p>Let&rsquo;s reverse getrandom now.</p>
<h3 id="reversing-getrandom">Reversing getrandom</h3>
<p>Here is what the code looks like:</p>
<figure>
    <img src="/bsides/getrandom-md.png"/> 
</figure>

<p>The decompiled code looks good enough.</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">getrandom</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">v0</span><span class="p">;</span> <span class="c1">// eax
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// eax
</span><span class="c1"></span>  <span class="kt">int</span> <span class="o">*</span><span class="n">v2</span><span class="p">;</span> <span class="c1">// ecx
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// esi
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// eax
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// edi
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v6</span><span class="p">;</span> <span class="c1">// esi
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v7</span><span class="p">;</span> <span class="c1">// eax
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v8</span><span class="p">;</span> <span class="c1">// esi
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v9</span><span class="p">;</span> <span class="c1">// edi
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v10</span><span class="p">;</span> <span class="c1">// eax
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v11</span><span class="p">;</span> <span class="c1">// edi
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v12</span><span class="p">;</span> <span class="c1">// esi
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v13</span><span class="p">;</span> <span class="c1">// eax
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v14</span><span class="p">;</span> <span class="c1">// esi
</span><span class="c1"></span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v15</span><span class="p">;</span> <span class="c1">// ecx
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">v16</span><span class="p">;</span> <span class="c1">// ecx
</span><span class="c1"></span>
  <span class="n">v0</span> <span class="o">=</span> <span class="n">dword_E54018</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">dword_E54018</span> <span class="o">&gt;=</span> <span class="mi">351</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="mi">175</span><span class="p">;</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dword_E54384</span><span class="p">;</span>
    <span class="k">do</span>
    <span class="p">{</span>
      <span class="n">v3</span> <span class="o">=</span> <span class="o">*</span><span class="n">v2</span><span class="p">;</span>
      <span class="n">v4</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="o">*</span><span class="p">(</span><span class="n">v2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">v2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="o">*</span><span class="n">v2</span> <span class="o">^</span> <span class="o">*</span><span class="p">(</span><span class="n">v2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x7FFFFu</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="n">dword_E5437C</span><span class="p">[</span><span class="n">v4</span><span class="p">]</span> <span class="o">^</span> <span class="o">-</span><span class="p">((</span><span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">v2</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">v2</span> <span class="o">^</span> <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">v2</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xE4BD75F5</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v4</span> <span class="o">&gt;=</span> <span class="mi">351</span> <span class="p">)</span>
      <span class="n">v4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">v5</span> <span class="o">=</span> <span class="n">v2</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="n">v6</span> <span class="o">=</span> <span class="p">((</span><span class="n">v3</span> <span class="o">^</span> <span class="p">(</span><span class="n">v3</span> <span class="o">^</span> <span class="n">v2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x7FFFFu</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="n">mt</span><span class="p">[</span><span class="n">v4</span><span class="p">]</span> <span class="o">^</span> <span class="o">-</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">v3</span> <span class="o">^</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)(</span><span class="n">v3</span> <span class="o">^</span> <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">v2</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xE4BD75F5</span><span class="p">;</span>
      <span class="n">v7</span> <span class="o">=</span> <span class="n">v4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="o">*</span><span class="n">v2</span> <span class="o">=</span> <span class="n">v6</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v7</span> <span class="o">&gt;=</span> <span class="mi">351</span> <span class="p">)</span>
      <span class="n">v7</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">v8</span> <span class="o">=</span> <span class="n">v2</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
      <span class="n">v9</span> <span class="o">=</span> <span class="p">((</span><span class="n">v5</span> <span class="o">^</span> <span class="p">(</span><span class="n">v5</span> <span class="o">^</span> <span class="n">v2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x7FFFFu</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="n">mt</span><span class="p">[</span><span class="n">v7</span><span class="p">]</span> <span class="o">^</span> <span class="o">-</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">v5</span> <span class="o">^</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)(</span><span class="n">v5</span> <span class="o">^</span> <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">v2</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xE4BD75F5</span><span class="p">;</span>
      <span class="n">v10</span> <span class="o">=</span> <span class="n">v7</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">v2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v9</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v10</span> <span class="o">&gt;=</span> <span class="mi">351</span> <span class="p">)</span>
      <span class="n">v10</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">v11</span> <span class="o">=</span> <span class="n">v2</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
      <span class="n">v12</span> <span class="o">=</span> <span class="p">((</span><span class="n">v8</span> <span class="o">^</span> <span class="p">(</span><span class="n">v8</span> <span class="o">^</span> <span class="n">v2</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x7FFFFu</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="n">mt</span><span class="p">[</span><span class="n">v10</span><span class="p">]</span> <span class="o">^</span> <span class="o">-</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">v8</span> <span class="o">^</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)(</span><span class="n">v8</span> <span class="o">^</span> <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">v2</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xE4BD75F5</span><span class="p">;</span>
      <span class="n">v13</span> <span class="o">=</span> <span class="n">v10</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">v2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">v12</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v13</span> <span class="o">&gt;=</span> <span class="mi">351</span> <span class="p">)</span>
      <span class="n">v13</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">v14</span> <span class="o">=</span> <span class="p">((</span><span class="n">v11</span> <span class="o">^</span> <span class="p">(</span><span class="n">v11</span> <span class="o">^</span> <span class="n">v2</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x7FFFFu</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="n">mt</span><span class="p">[</span><span class="n">v13</span><span class="p">]</span> <span class="o">^</span> <span class="o">-</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">v11</span> <span class="o">^</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)(</span><span class="n">v11</span> <span class="o">^</span> <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">v2</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xE4BD75F5</span><span class="p">;</span>
      <span class="n">v1</span> <span class="o">=</span> <span class="n">v13</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">v2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">v14</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v1</span> <span class="o">&gt;=</span> <span class="mi">351</span> <span class="p">)</span>
      <span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">v2</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">v2</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dword_E548FC</span> <span class="p">);</span>
    <span class="n">dword_E548F8</span> <span class="o">=</span> <span class="n">dword_E54638</span> <span class="o">^</span> <span class="p">((</span><span class="n">dword_E548F8</span> <span class="o">^</span> <span class="p">(</span><span class="n">dword_E548F8</span> <span class="o">^</span> <span class="n">mt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x7FFFFu</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="o">-</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">dword_E548F8</span> <span class="o">^</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)(</span><span class="n">dword_E548F8</span> <span class="o">^</span> <span class="n">LOBYTE</span><span class="p">(</span><span class="n">mt</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xE4BD75F5</span><span class="p">;</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">v15</span> <span class="o">=</span> <span class="n">mt</span><span class="p">[</span><span class="n">v0</span><span class="p">];</span>
  <span class="n">dword_E54018</span> <span class="o">=</span> <span class="n">v0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">v16</span> <span class="o">=</span> <span class="p">((((</span><span class="n">v15</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">^</span> <span class="n">v15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xCABCA5</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">v15</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">^</span> <span class="n">v15</span><span class="p">;</span>
  <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)(</span><span class="n">v16</span> <span class="o">^</span> <span class="p">((((</span><span class="n">v16</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFAB</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">^</span> <span class="n">v16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div><p>Looks like a normal getrandom function from mt19937 but the thing is, it is not. Because the length of the array is 351, this is called mt11213.</p>
<p>After looking on the internet for some constants I found this <a href="http://www.ai.mit.edu/courses/6.836-s03/handouts/sierra/random.c">page</a>, maybe we can work with that.</p>
<p>The only difference with the program was the factor, also I had to change from long to int because this was written for a 32 bit machine (I spent two hours debugging this because I forgot to use -m32 lol ü§¶üèΩ).</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;math.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#define RAND_MASK 0x3FFFFFFF
</span><span class="cp"></span>
<span class="cp">#define N 351
</span><span class="cp">#define M 175
</span><span class="cp">#define R 19
</span><span class="cp">#define TEMU 11
</span><span class="cp">#define TEMS 7
</span><span class="cp">#define TEMT 15
</span><span class="cp">#define TEML 17
</span><span class="cp"></span>
<span class="cp">#define MATRIX_A 0xE4BD75F5
</span><span class="cp">#define TEMB     0x655E5280
</span><span class="cp">#define TEMC     0xFFD58000
</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mt</span><span class="p">[</span><span class="n">N</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mti</span><span class="o">=</span><span class="n">N</span><span class="p">;</span>


<span class="k">extern</span> <span class="kt">void</span> <span class="nf">set_seed</span> <span class="p">(</span><span class="kt">int</span> <span class="n">seed</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">seed</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">mti</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">mti</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span> <span class="n">mti</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// s = s * 29943829 - 1;
</span><span class="c1"></span>    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span>  <span class="mi">29945647</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">mt</span><span class="p">[</span><span class="n">mti</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dump</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">mt</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">genrandom</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">mti</span> <span class="o">&gt;=</span> <span class="n">N</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">LOWER_MASK</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1u</span> <span class="o">&lt;&lt;</span> <span class="n">R</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">UPPER_MASK</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">R</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">kk</span><span class="p">,</span> <span class="n">km</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">kk</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">km</span><span class="o">=</span><span class="n">M</span><span class="p">;</span> <span class="n">kk</span> <span class="o">&lt;</span> <span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">kk</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">mt</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">UPPER_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mt</span><span class="p">[</span><span class="n">kk</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LOWER_MASK</span><span class="p">);</span>
      <span class="n">mt</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">mt</span><span class="p">[</span><span class="n">km</span><span class="p">]</span> <span class="o">^</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">y</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MATRIX_A</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">km</span> <span class="o">&gt;=</span> <span class="n">N</span><span class="p">)</span> <span class="n">km</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">mt</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">UPPER_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">LOWER_MASK</span><span class="p">);</span>
    <span class="n">mt</span><span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mt</span><span class="p">[</span><span class="n">M</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">y</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MATRIX_A</span><span class="p">);</span>
    <span class="n">mti</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">mt</span><span class="p">[</span><span class="n">mti</span><span class="o">++</span><span class="p">];</span>
  <span class="n">y</span> <span class="o">^=</span>  <span class="n">y</span> <span class="o">&gt;&gt;</span> <span class="n">TEMU</span><span class="p">;</span>
  <span class="n">y</span> <span class="o">^=</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;&lt;</span> <span class="n">TEMS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TEMB</span><span class="p">;</span>
  <span class="n">y</span> <span class="o">^=</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;&lt;</span> <span class="n">TEMT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TEMC</span><span class="p">;</span>
  <span class="n">y</span> <span class="o">^=</span>  <span class="n">y</span> <span class="o">&gt;&gt;</span> <span class="n">TEML</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">y</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">1569888000</span> <span class="cm">/*1546300800*/</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">1582583270</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">set_seed</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%x&#34;</span><span class="p">,</span> <span class="n">genrandom</span><span class="p">()</span> <span class="o">^</span> <span class="mh">0x55</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>This generates a 263 MiB file:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">gcc  bruteforce.c <span class="o">&amp;&amp;</span> ./a.out &gt; keys.txt
</code></pre></div><p>Then I wrote a little program in python to try to brute force the key, since we know that the file is png, and the first 8 bytes are fixed.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">DES</span>
<span class="n">cipher</span> <span class="o">=</span> <span class="s2">&#34;cd0c8716e99ae841&#34;</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;hex&#34;</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;keys.txt&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">myfile</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">myfile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="n">p</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">pas</span> <span class="o">=</span> <span class="n">p</span>
    <span class="n">l</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">/</span> <span class="n">l</span> <span class="o">&gt;=</span> <span class="n">p</span><span class="p">:</span>
      <span class="k">print</span><span class="p">(</span><span class="s2">&#34;{}%&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
      <span class="n">p</span> <span class="o">+=</span> <span class="n">pas</span>
      <span class="n">keyh</span> <span class="o">=</span> <span class="n">key</span>
      <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;hex&#34;</span><span class="p">)</span>
      <span class="n">out</span> <span class="o">=</span> <span class="n">DES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">cipher</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">chr</span><span class="p">(</span><span class="mh">0x89</span><span class="p">)</span> <span class="ow">and</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">chr</span><span class="p">(</span><span class="mh">0x50</span><span class="p">)</span> <span class="ow">and</span> <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="nb">chr</span><span class="p">(</span><span class="mh">0x4e</span><span class="p">)</span> <span class="ow">and</span> <span class="n">out</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="nb">chr</span><span class="p">(</span><span class="mh">0x47</span><span class="p">)</span> <span class="ow">and</span> \
       <span class="n">out</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="nb">chr</span><span class="p">(</span><span class="mh">0x0d</span><span class="p">)</span> <span class="ow">and</span> <span class="n">out</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="nb">chr</span><span class="p">(</span><span class="mh">0xa</span><span class="p">)</span> <span class="ow">and</span> <span class="n">out</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="nb">chr</span><span class="p">(</span><span class="mh">0x1a</span><span class="p">)</span> <span class="ow">and</span> <span class="n">out</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="nb">chr</span><span class="p">(</span><span class="mh">0x0a</span><span class="p">):</span>
      <span class="k">print</span><span class="p">(</span><span class="s2">&#34;FOUND .....&#34;</span><span class="p">)</span>
      <span class="k">print</span><span class="p">(</span><span class="n">keyh</span><span class="p">)</span>
      <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div><p>After 5 minutes I find the key, and I decrypt the image:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">DES</span>
<span class="n">key</span> <span class="o">=</span> <span class="s2">&#34;a051b8a16f8542da&#34;</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;hex&#34;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;flag.png.enc&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">myfile</span><span class="p">:</span>
    <span class="n">image</span><span class="o">=</span>  <span class="n">myfile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">content</span> <span class="o">=</span> <span class="n">DES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">DES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">IV</span><span class="o">=</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;flag.png&#34;</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">myfile</span><span class="p">:</span>
    <span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</code></pre></div><p>And yaas! We have the flag!</p>
<figure>
    <img src="/bsides/flag-md.png"/> 
</figure>




        <div class="footer">
    Powered by <a href="https://gohugo.io/">Hugo</a> with
    <a href="https://github.com/mrmierzejewski/hugo-theme-console/">Console Theme</a>. 
</div>

    </div>
  </body>
</html>
