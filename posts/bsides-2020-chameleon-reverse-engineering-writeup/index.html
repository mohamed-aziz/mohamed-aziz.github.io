<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Mohamed Aziz Knani (محمد عزيز الكناني) website/posts/bsides-2020-chameleon-reverse-engineering-writeup/</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="all,follow">
    <meta name="googlebot" content="index,follow,snippet,archive">
    <link rel="stylesheet" href="https://aziz.tn/hugo-theme-console/css/terminal-0.7.1.min.css">
    <link rel="stylesheet" href="https://aziz.tn/hugo-theme-console/css/animate-3.7.2.min.css">
    <link rel="stylesheet" href="https://aziz.tn/hugo-theme-console/css/console.css">
    
      <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
      <![endif]-->
       <meta property="og:title" content="Bsides 2020, chameleon reverse engineering writeup" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://aziz.tn/posts/bsides-2020-chameleon-reverse-engineering-writeup/" /><meta property="article:published_time" content="2020-04-09T00:00:00+01:00" />



<meta name="twitter:title" content="Bsides 2020, chameleon reverse engineering writeup"/>
<meta name="twitter:description" content="This was originally published on sousse.love
Introduction BsidesSF had really really good reverse engineering challenges, but I loved two challenges. One windows reverse challenge called chameleon and another esp32 firmware reverse challenge called smart-locky which I didn&rsquo;t manage to solve in time.
The challenge Problem statement We are given two files chameleon.exe and flag.png.enc, this looks trivial enough we need to reverse the encryption algorithm to give us the original flag."/>

</head>
<body class="terminal">
    <div class="container">
        <div class="terminal-nav">
          <header class="terminal-logo">
            <div class="logo terminal-prompt">
              
              
              <a href="https://aziz.tn/" class="no-style ">Mohamed Aziz Knani (محمد عزيز الكناني) website</a>:~# 
              <a href='https://aziz.tn/posts'>posts</a>/<a href='https://aziz.tn/posts/bsides-2020-chameleon-reverse-engineering-writeup'>bsides-2020-chameleon-reverse-engineering-writeup</a>/</div></header>
          <nav class="terminal-menu">
            <ul vocab="https://schema.org/" typeof="BreadcrumbList">
                
                <li><a href="https://aziz.tn/about/" typeof="ListItem">about/</a></li>
                
                <li><a href="https://aziz.tn/posts/" typeof="ListItem">posts/</a></li>
                
            </ul>
          </nav>
        </div>
    </div>

    <div class="container animated fadeInDown fast" >
        
<h1>Bsides 2020, chameleon reverse engineering writeup</h1>

Apr. 9, 2020


<br/><br/>
<p>This was originally published on <a href="https://www.sousse.love/post/chameleon-bsides/">sousse.love</a></p>
<h2 id="introduction">Introduction</h2>
<p>BsidesSF had really really good reverse engineering challenges, but I loved two challenges. One windows reverse challenge called chameleon and another esp32 firmware reverse challenge called smart-locky which I didn&rsquo;t manage to solve in time.</p>
<h2 id="the-challenge">The challenge</h2>
<h3 id="problem-statement">Problem statement</h3>
<p>We are given two files <a href="static/bsides/chameleon.exe">chameleon.exe</a> and <a href="static/bsides/flag.png.enc">flag.png.enc</a>, this looks trivial enough we need to reverse the encryption algorithm to give us the original flag.png.</p>
<p>The problem statment also says that file was encrypted in the last months.</p>
<p>Reading the statment it looked like a simple challenge where you brute force the seed of a default mt19937 implementation, but the problem had only two solves, so I thought there must be some twist.</p>
<h3 id="first-glance-at-the-binary">First glance at the binary</h3>
<p>When you first execute the binary it gives you two options, to encrypt or decrypt files.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Usage: chameleon.exe [--encrypt|&lt;--decrypt --id=&lt;id&gt;&gt;] &lt;infile&gt; &lt;outfile&gt;

Example: chameleon.exe --encrypt plaintext.txt ciphertext.txt
Example: chameleon.exe --decrypt --id=abcd1234 ciphertext.txt plaintext.txt
</code></pre></div><p>I knew where to look, and I didn&rsquo;t focus on the decryption stuff to be honest.</p>
<h3 id="reversing-the-binary">Reversing the binary</h3>
<p>After identifying the encrypt function and changing some function names here is what the assembly looks like (you might want to zoom):</p>
<figure>
    <img src="/bsides/encrypt_func-md.png"/> 
</figure>

<p>And here is what the hexrays decompiler gives us after changing some types and variable names:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span> __usercall <span style="color:#a6e22e">encrypt</span>(<span style="color:#66d9ef">const</span> CHAR <span style="color:#f92672">*</span>output<span style="color:#960050;background-color:#1e0010">@</span><span style="color:#f92672">&lt;</span>ebx<span style="color:#f92672">&gt;</span>, <span style="color:#66d9ef">const</span> CHAR <span style="color:#f92672">*</span>input)
{
  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>file_content;
  BYTE <span style="color:#f92672">*</span>new_file_ptr;
  FILE <span style="color:#f92672">*</span>v4;
  DWORD pdwDataLen;
  HCRYPTKEY phKey;
  HCRYPTPROV phProv;
  byte pbData[<span style="color:#ae81ff">20</span>];
  <span style="color:#66d9ef">char</span> v9[<span style="color:#ae81ff">8</span>];

  file_content <span style="color:#f92672">=</span> read_file(input, <span style="color:#f92672">&amp;</span>pdwDataLen);
  new_file_ptr <span style="color:#f92672">=</span> (BYTE <span style="color:#f92672">*</span>)realloc(file_content, pdwDataLen <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>);
  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>CryptAcquireContextA(<span style="color:#f92672">&amp;</span>phProv, <span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#34;Microsoft Enhanced Cryptographic Provider v1.0&#34;</span>, <span style="color:#ae81ff">1u</span>, <span style="color:#ae81ff">0xF0000000</span>) )
    <span style="color:#66d9ef">goto</span> failure;
  mersenne_twister((<span style="color:#66d9ef">int</span>)v9);                    <span style="color:#75715e">// generate 8 byte key
</span><span style="color:#75715e"></span>  <span style="color:#f92672">*</span>(_WORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>pbData[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  pbData[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;
  <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>pbData[<span style="color:#ae81ff">8</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;
  <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>pbData[<span style="color:#ae81ff">12</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)v9;
  <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>pbData[<span style="color:#ae81ff">16</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>v9[<span style="color:#ae81ff">4</span>];
  pbData[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
  <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>pbData[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">26113</span>;
  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>CryptImportKey(phProv, pbData, <span style="color:#ae81ff">0x14u</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1u</span>, <span style="color:#f92672">&amp;</span>phKey)
    <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>CryptEncrypt(phKey, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, new_file_ptr, <span style="color:#f92672">&amp;</span>pdwDataLen, pdwDataLen <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>) )
  {
failure:
    v4 <span style="color:#f92672">=</span> _iob_func();
    fprintf(v4 <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#34;Encryption failed</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
    exit(<span style="color:#ae81ff">1</span>);
  }
  sub_E51AA0((<span style="color:#66d9ef">int</span>)v9);
  sub_E51F50(output, new_file_ptr, pdwDataLen);
  free(new_file_ptr);
}
</code></pre></div><p>All right looks simple enough, here are the algorithm steps:</p>
<ul>
<li>call to CryptAcquireContextA, this is like an encryption algorithm factory in windows</li>
<li>call to a function that I called mersenne_twister</li>
<li>sets some values in pbData</li>
<li>call to CryptImportKey</li>
<li>call to CryptEncrypt</li>
</ul>
<p>You can read this <a href="https://docs.microsoft.com/en-us/windows/win32/seccrypto/example-c-program--importing-a-plaintext-key">tutorial</a> to understand how <strong>CryptImportKey</strong> works.</p>
<p>This is an example key blob from the page above:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">BYTE DesKeyBlob[] <span style="color:#f92672">=</span> {
    <span style="color:#ae81ff">0x08</span>,<span style="color:#ae81ff">0x02</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0x66</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>, <span style="color:#75715e">// BLOB header
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0x08</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,                     <span style="color:#75715e">// key length, in bytes
</span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0xf1</span>,<span style="color:#ae81ff">0x0e</span>,<span style="color:#ae81ff">0x25</span>,<span style="color:#ae81ff">0x7c</span>,<span style="color:#ae81ff">0x6b</span>,<span style="color:#ae81ff">0xce</span>,<span style="color:#ae81ff">0x0d</span>,<span style="color:#ae81ff">0x34</span>  <span style="color:#75715e">// DES key with parity
</span><span style="color:#75715e"></span>    };
</code></pre></div><p>We can see that our example also uses DES using CBC mode of operation, we also see that the DES key is passed as the last 8 bytes (with byte of parity) of the array.</p>
<p>Ok so the bread and butter of this problem is knowing how the mersenne twister works.</p>
<h3 id="reversing-mersenne-twister">Reversing mersenne_twister</h3>
<p>This is what the code looks like:</p>
<figure>
    <img src="/bsides/mersenne_twister-md.png"/> 
</figure>

<p>We can see that there are two loops.</p>
<p>Here is the decompiled code, it looks really clean after some type changes</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">char</span> __usercall mersenne_twister<span style="color:#960050;background-color:#1e0010">@</span><span style="color:#f92672">&lt;</span>al<span style="color:#f92672">&gt;</span>(<span style="color:#66d9ef">int</span> a1<span style="color:#960050;background-color:#1e0010">@</span><span style="color:#f92672">&lt;</span>edi<span style="color:#f92672">&gt;</span>)
{
  <span style="color:#66d9ef">int</span> v1; <span style="color:#75715e">// eax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">signed</span> <span style="color:#66d9ef">int</span> v2; <span style="color:#75715e">// ecx
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> v3; <span style="color:#75715e">// esi
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> result; <span style="color:#75715e">// al
</span><span style="color:#75715e"></span>
  v1 <span style="color:#f92672">=</span> time64(<span style="color:#ae81ff">0</span>);
  v2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#66d9ef">do</span>
  {
    v1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">29945647</span> <span style="color:#f92672">*</span> v1 <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
    mt[v2<span style="color:#f92672">++</span>] <span style="color:#f92672">=</span> v1;
  }
  <span style="color:#66d9ef">while</span> ( v2 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">351</span> );
  dword_E54018 <span style="color:#f92672">=</span> v2;
  v3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#66d9ef">do</span>
  {
    result <span style="color:#f92672">=</span> getrandom() <span style="color:#f92672">^</span> <span style="color:#ae81ff">0x55</span>;
    <span style="color:#f92672">*</span>(_BYTE <span style="color:#f92672">*</span>)(v3<span style="color:#f92672">++</span> <span style="color:#f92672">+</span> a1) <span style="color:#f92672">=</span> result;
  }
  <span style="color:#66d9ef">while</span> ( v3 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">8</span> );
  <span style="color:#66d9ef">return</span> result;
}
</code></pre></div><p>If you implemented mersenne twister, the first loop is the set seed function, this is gonna put numbers in an array I call mt.</p>
<p>The <strong>critical</strong> part to notice is the call to time64, the twister is seeded with current time.</p>
<p>Let&rsquo;s reverse getrandom now.</p>
<h3 id="reversing-getrandom">Reversing getrandom</h3>
<p>Here is what the code looks like:</p>
<figure>
    <img src="/bsides/getrandom-md.png"/> 
</figure>

<p>The decompiled code looks good enough.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getrandom</span>()
{
  <span style="color:#66d9ef">int</span> v0; <span style="color:#75715e">// eax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v1; <span style="color:#75715e">// eax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>v2; <span style="color:#75715e">// ecx
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v3; <span style="color:#75715e">// esi
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v4; <span style="color:#75715e">// eax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v5; <span style="color:#75715e">// edi
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> v6; <span style="color:#75715e">// esi
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v7; <span style="color:#75715e">// eax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v8; <span style="color:#75715e">// esi
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> v9; <span style="color:#75715e">// edi
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v10; <span style="color:#75715e">// eax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v11; <span style="color:#75715e">// edi
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> v12; <span style="color:#75715e">// esi
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v13; <span style="color:#75715e">// eax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> v14; <span style="color:#75715e">// esi
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> v15; <span style="color:#75715e">// ecx
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v16; <span style="color:#75715e">// ecx
</span><span style="color:#75715e"></span>
  v0 <span style="color:#f92672">=</span> dword_E54018;
  <span style="color:#66d9ef">if</span> ( dword_E54018 <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">351</span> )
  {
    v1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">175</span>;
    v2 <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>dword_E54384;
    <span style="color:#66d9ef">do</span>
    {
      v3 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>v2;
      v4 <span style="color:#f92672">=</span> v1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
      <span style="color:#f92672">*</span>(v2 <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">=</span> ((<span style="color:#f92672">*</span>(v2 <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">^</span> (<span style="color:#f92672">*</span>v2 <span style="color:#f92672">^</span> <span style="color:#f92672">*</span>(v2 <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7FFFFu</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">^</span> dword_E5437C[v4] <span style="color:#f92672">^</span> <span style="color:#f92672">-</span>((<span style="color:#f92672">*</span>((_BYTE <span style="color:#f92672">*</span>)v2 <span style="color:#f92672">-</span> <span style="color:#ae81ff">4</span>) <span style="color:#f92672">^</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)(<span style="color:#f92672">*</span>(_BYTE <span style="color:#f92672">*</span>)v2 <span style="color:#f92672">^</span> <span style="color:#f92672">*</span>((_BYTE <span style="color:#f92672">*</span>)v2 <span style="color:#f92672">-</span> <span style="color:#ae81ff">4</span>))) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xE4BD75F5</span>;
      <span style="color:#66d9ef">if</span> ( v4 <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">351</span> )
      v4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
      v5 <span style="color:#f92672">=</span> v2[<span style="color:#ae81ff">1</span>];
      v6 <span style="color:#f92672">=</span> ((v3 <span style="color:#f92672">^</span> (v3 <span style="color:#f92672">^</span> v2[<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7FFFFu</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">^</span> mt[v4] <span style="color:#f92672">^</span> <span style="color:#f92672">-</span>(((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)v3 <span style="color:#f92672">^</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)(v3 <span style="color:#f92672">^</span> <span style="color:#f92672">*</span>((_BYTE <span style="color:#f92672">*</span>)v2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>))) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xE4BD75F5</span>;
      v7 <span style="color:#f92672">=</span> v4 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
      <span style="color:#f92672">*</span>v2 <span style="color:#f92672">=</span> v6;
      <span style="color:#66d9ef">if</span> ( v7 <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">351</span> )
      v7 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
      v8 <span style="color:#f92672">=</span> v2[<span style="color:#ae81ff">2</span>];
      v9 <span style="color:#f92672">=</span> ((v5 <span style="color:#f92672">^</span> (v5 <span style="color:#f92672">^</span> v2[<span style="color:#ae81ff">2</span>]) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7FFFFu</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">^</span> mt[v7] <span style="color:#f92672">^</span> <span style="color:#f92672">-</span>(((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)v5 <span style="color:#f92672">^</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)(v5 <span style="color:#f92672">^</span> <span style="color:#f92672">*</span>((_BYTE <span style="color:#f92672">*</span>)v2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>))) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xE4BD75F5</span>;
      v10 <span style="color:#f92672">=</span> v7 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
      v2[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> v9;
      <span style="color:#66d9ef">if</span> ( v10 <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">351</span> )
      v10 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
      v11 <span style="color:#f92672">=</span> v2[<span style="color:#ae81ff">3</span>];
      v12 <span style="color:#f92672">=</span> ((v8 <span style="color:#f92672">^</span> (v8 <span style="color:#f92672">^</span> v2[<span style="color:#ae81ff">3</span>]) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7FFFFu</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">^</span> mt[v10] <span style="color:#f92672">^</span> <span style="color:#f92672">-</span>(((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)v8 <span style="color:#f92672">^</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)(v8 <span style="color:#f92672">^</span> <span style="color:#f92672">*</span>((_BYTE <span style="color:#f92672">*</span>)v2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">12</span>))) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xE4BD75F5</span>;
      v13 <span style="color:#f92672">=</span> v10 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
      v2[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> v12;
      <span style="color:#66d9ef">if</span> ( v13 <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">351</span> )
      v13 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
      v14 <span style="color:#f92672">=</span> ((v11 <span style="color:#f92672">^</span> (v11 <span style="color:#f92672">^</span> v2[<span style="color:#ae81ff">4</span>]) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7FFFFu</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">^</span> mt[v13] <span style="color:#f92672">^</span> <span style="color:#f92672">-</span>(((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)v11 <span style="color:#f92672">^</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)(v11 <span style="color:#f92672">^</span> <span style="color:#f92672">*</span>((_BYTE <span style="color:#f92672">*</span>)v2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>))) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xE4BD75F5</span>;
      v1 <span style="color:#f92672">=</span> v13 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
      v2[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> v14;
      <span style="color:#66d9ef">if</span> ( v1 <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">351</span> )
      v1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
      v2 <span style="color:#f92672">+=</span> <span style="color:#ae81ff">5</span>;
    }
    <span style="color:#66d9ef">while</span> ( (<span style="color:#66d9ef">signed</span> <span style="color:#66d9ef">int</span>)v2 <span style="color:#f92672">&lt;</span> (<span style="color:#66d9ef">signed</span> <span style="color:#66d9ef">int</span>)<span style="color:#f92672">&amp;</span>dword_E548FC );
    dword_E548F8 <span style="color:#f92672">=</span> dword_E54638 <span style="color:#f92672">^</span> ((dword_E548F8 <span style="color:#f92672">^</span> (dword_E548F8 <span style="color:#f92672">^</span> mt[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7FFFFu</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">^</span> <span style="color:#f92672">-</span>(((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)dword_E548F8 <span style="color:#f92672">^</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)(dword_E548F8 <span style="color:#f92672">^</span> LOBYTE(mt[<span style="color:#ae81ff">0</span>]))) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xE4BD75F5</span>;
    v0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  }
  v15 <span style="color:#f92672">=</span> mt[v0];
  dword_E54018 <span style="color:#f92672">=</span> v0 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
  v16 <span style="color:#f92672">=</span> ((((v15 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">11</span>) <span style="color:#f92672">^</span> v15) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xCABCA5</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">7</span>) <span style="color:#f92672">^</span> (v15 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">11</span>) <span style="color:#f92672">^</span> v15;
  <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)(v16 <span style="color:#f92672">^</span> ((((v16 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFFFFAB</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">15</span>) <span style="color:#f92672">^</span> v16) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">17</span>));
}
</code></pre></div><p>Looks like a normal getrandom function from mt19937 but the thing is, it is not. Because the length of the array is 351, this is called mt11213.</p>
<p>After looking on the internet for some constants I found this <a href="http://www.ai.mit.edu/courses/6.836-s03/handouts/sierra/random.c">page</a>, maybe we can work with that.</p>
<p>The only difference with the program was the factor, also I had to change from long to int because this was written for a 32 bit machine (I spent two hours debugging this because I forgot to use -m32 lol 🤦🏽).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;math.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#define RAND_MASK 0x3FFFFFFF
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#define N 351
</span><span style="color:#75715e">#define M 175
</span><span style="color:#75715e">#define R 19
</span><span style="color:#75715e">#define TEMU 11
</span><span style="color:#75715e">#define TEMS 7
</span><span style="color:#75715e">#define TEMT 15
</span><span style="color:#75715e">#define TEML 17
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#define MATRIX_A 0xE4BD75F5
</span><span style="color:#75715e">#define TEMB     0x655E5280
</span><span style="color:#75715e">#define TEMC     0xFFD58000
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> mt[N];
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> mti<span style="color:#f92672">=</span>N;


<span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">set_seed</span> (<span style="color:#66d9ef">int</span> seed) {
  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> s <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)seed;
  <span style="color:#66d9ef">for</span> (mti<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; mti<span style="color:#f92672">&lt;</span>N; mti<span style="color:#f92672">++</span>) {
    <span style="color:#75715e">// s = s * 29943829 - 1;
</span><span style="color:#75715e"></span>    s <span style="color:#f92672">=</span> s <span style="color:#f92672">*</span>  <span style="color:#ae81ff">29945647</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
    mt[mti] <span style="color:#f92672">=</span> s;
  }
  <span style="color:#66d9ef">return</span>;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">dump</span>() {
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> N; i<span style="color:#f92672">++</span>) {
       printf(<span style="color:#e6db74">&#34;%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, mt[i]);
    }
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">genrandom</span> () {
  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> y;
  <span style="color:#66d9ef">if</span> (mti <span style="color:#f92672">&gt;=</span> N) {
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> LOWER_MASK <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1u</span> <span style="color:#f92672">&lt;&lt;</span> R) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> UPPER_MASK <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> R;
    <span style="color:#66d9ef">int</span> kk, km;
    <span style="color:#66d9ef">for</span> (kk<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, km<span style="color:#f92672">=</span>M; kk <span style="color:#f92672">&lt;</span> N<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; kk<span style="color:#f92672">++</span>) {
      y <span style="color:#f92672">=</span> (mt[kk] <span style="color:#f92672">&amp;</span> UPPER_MASK) <span style="color:#f92672">|</span> (mt[kk<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">&amp;</span> LOWER_MASK);
      mt[kk] <span style="color:#f92672">=</span> mt[km] <span style="color:#f92672">^</span> (y <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">^</span> (<span style="color:#f92672">-</span>(y <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> MATRIX_A);

      <span style="color:#66d9ef">if</span> (<span style="color:#f92672">++</span>km <span style="color:#f92672">&gt;=</span> N) km <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }
    y <span style="color:#f92672">=</span> (mt[N<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">&amp;</span> UPPER_MASK) <span style="color:#f92672">|</span> (mt[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&amp;</span> LOWER_MASK);
    mt[N<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> mt[M<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">^</span> (y <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">^</span> (<span style="color:#f92672">-</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)(y <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;</span> MATRIX_A);
    mti <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  }
  y <span style="color:#f92672">=</span> mt[mti<span style="color:#f92672">++</span>];
  y <span style="color:#f92672">^=</span>  y <span style="color:#f92672">&gt;&gt;</span> TEMU;
  y <span style="color:#f92672">^=</span> (y <span style="color:#f92672">&lt;&lt;</span> TEMS) <span style="color:#f92672">&amp;</span> TEMB;
  y <span style="color:#f92672">^=</span> (y <span style="color:#f92672">&lt;&lt;</span> TEMT) <span style="color:#f92672">&amp;</span> TEMC;
  y <span style="color:#f92672">^=</span>  y <span style="color:#f92672">&gt;&gt;</span> TEML;

  <span style="color:#66d9ef">return</span> y<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xff</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>) {
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> t <span style="color:#f92672">=</span> <span style="color:#ae81ff">1569888000</span> <span style="color:#75715e">/*1546300800*/</span>; t <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1582583270</span>; t<span style="color:#f92672">++</span>) {
      set_seed(t);
      <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">8</span>; i<span style="color:#f92672">++</span>) {
	  printf(<span style="color:#e6db74">&#34;%x&#34;</span>, genrandom() <span style="color:#f92672">^</span> <span style="color:#ae81ff">0x55</span>);
      }
      printf(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
    }
}
</code></pre></div><p>This generates a 263 MiB file:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gcc  bruteforce.c <span style="color:#f92672">&amp;&amp;</span> ./a.out &gt; keys.txt
</code></pre></div><p>Then I wrote a little program in python to try to brute force the key, since we know that the file is png, and the first 8 bytes are fixed.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> Crypto.Cipher <span style="color:#f92672">import</span> DES
cipher <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;cd0c8716e99ae841&#34;</span><span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#34;hex&#34;</span>)

<span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;keys.txt&#34;</span>) <span style="color:#66d9ef">as</span> myfile:
    lines <span style="color:#f92672">=</span> myfile<span style="color:#f92672">.</span>read()<span style="color:#f92672">.</span>splitlines()
    p <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.01</span>
    pas <span style="color:#f92672">=</span> p
    l <span style="color:#f92672">=</span> float(len(lines))
<span style="color:#66d9ef">for</span> i, key <span style="color:#f92672">in</span> enumerate(lines):
    <span style="color:#66d9ef">if</span> i <span style="color:#f92672">/</span> l <span style="color:#f92672">&gt;=</span> p:
      <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;{}%&#34;</span><span style="color:#f92672">.</span>format(p <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>))
      p <span style="color:#f92672">+=</span> pas
      keyh <span style="color:#f92672">=</span> key
      key <span style="color:#f92672">=</span> key<span style="color:#f92672">.</span>zfill(<span style="color:#ae81ff">16</span>)<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#34;hex&#34;</span>)
      out <span style="color:#f92672">=</span> DES<span style="color:#f92672">.</span>new(key)<span style="color:#f92672">.</span>decrypt(cipher)
    <span style="color:#66d9ef">if</span> out[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> chr(<span style="color:#ae81ff">0x89</span>) <span style="color:#f92672">and</span> out[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> chr(<span style="color:#ae81ff">0x50</span>) <span style="color:#f92672">and</span> out[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">==</span> chr(<span style="color:#ae81ff">0x4e</span>) <span style="color:#f92672">and</span> out[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">==</span> chr(<span style="color:#ae81ff">0x47</span>) <span style="color:#f92672">and</span> \
       out[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">==</span> chr(<span style="color:#ae81ff">0x0d</span>) <span style="color:#f92672">and</span> out[<span style="color:#ae81ff">5</span>] <span style="color:#f92672">==</span> chr(<span style="color:#ae81ff">0xa</span>) <span style="color:#f92672">and</span> out[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">==</span> chr(<span style="color:#ae81ff">0x1a</span>) <span style="color:#f92672">and</span> out[<span style="color:#ae81ff">7</span>] <span style="color:#f92672">==</span> chr(<span style="color:#ae81ff">0x0a</span>):
      <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;FOUND .....&#34;</span>)
      <span style="color:#66d9ef">print</span>(keyh)
      exit(<span style="color:#ae81ff">0</span>)
</code></pre></div><p>After 5 minutes I find the key, and I decrypt the image:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> Crypto.Cipher <span style="color:#f92672">import</span> DES
key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;a051b8a16f8542da&#34;</span><span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#34;hex&#34;</span>)
<span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;flag.png.enc&#34;</span>) <span style="color:#66d9ef">as</span> myfile:
    image<span style="color:#f92672">=</span>  myfile<span style="color:#f92672">.</span>read()

content <span style="color:#f92672">=</span> DES<span style="color:#f92672">.</span>new(key, DES<span style="color:#f92672">.</span>MODE_CBC, IV<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>)<span style="color:#f92672">.</span>decrypt(image)

<span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;flag.png&#34;</span>, <span style="color:#e6db74">&#34;w&#34;</span>) <span style="color:#66d9ef">as</span> myfile:
    myfile<span style="color:#f92672">.</span>write(content)
</code></pre></div><p>And yaas! We have the flag!</p>
<figure>
    <img src="/bsides/flag-md.png"/> 
</figure>




        <div class="footer">
    Powered by <a href="https://gohugo.io/">Hugo</a> with
    <a href="https://github.com/mrmierzejewski/hugo-theme-console/">Console Theme</a>. 
</div>

    </div>
  </body>
</html>
